<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple FFT Grid</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #grid-container {
            display: grid;
            /* Set up grid layout */
            gap: 1px;
            /* Gap between squares */
            /* Grid columns/rows will be set by JS */
        }

        .grid-square {
            /* Background color and transition set by JS */
            border: none;
        }
    </style>
</head>

<body>
    <div id="grid-container"></div>

    <script>
        const gridContainer = document.getElementById('grid-container');
        const socketUrl = 'ws://localhost:8080/fft';
        let socket;
        let squares = [];
        let numBands = 0;
        const maxSquares = 300; // Limit the number of squares

        function createGrid() {
            if (!gridContainer) return;
            gridContainer.innerHTML = ''; // Clear previous grid
            squares = [];

            const containerWidth = window.innerWidth; // Use window size directly
            const containerHeight = window.innerHeight;
            let bestFit = { cols: 0, rows: 0, size: 0, count: 0 };

            // Find best square size to fit within maxSquares and fill screen
            for (let size = 25; size >= 2; size--) { // Iterate possible sizes
                const cols = Math.floor(containerWidth / size);
                const rows = Math.floor(containerHeight / size);
                const count = cols * rows;

                if (count > 0 && count <= maxSquares) {
                    bestFit = { cols, rows, size, count };
                    break;
                } else if (count > maxSquares && bestFit.count === 0) {
                    // Fallback if no fit under maxSquares is found
                    bestFit = { cols, rows, size, count };
                }
            }

            if (bestFit.count === 0) {
                console.error("Could not fit any squares.");
                return;
            }

            console.log(`Creating grid: ${bestFit.cols}x${bestFit.rows} (${bestFit.count}) @ ${bestFit.size}px`);

            // Apply grid styles
            gridContainer.style.gridTemplateColumns = `repeat(${bestFit.cols}, ${bestFit.size}px)`;
            gridContainer.style.gridTemplateRows = `repeat(${bestFit.rows}, ${bestFit.size}px)`;

            // Create squares
            for (let i = 0; i < bestFit.count; i++) {
                const square = document.createElement('div');
                square.classList.add('grid-square');
                square.style.width = `${bestFit.size}px`;
                square.style.height = `${bestFit.size}px`;
                square.style.backgroundColor = 'rgba(0, 0, 20, 0.1)'; // Initial dark color
                square.style.transition = 'background-color 0.05s linear'; // Smooth color change
                gridContainer.appendChild(square);
                squares.push(square);
            }
        }

        function updateSquares(magnitudes) {
            if (!squares.length || !magnitudes || magnitudes.length === 0) return;

            const avgMagnitude = magnitudes.reduce((sum, val) => sum + (val || 0), 0) / magnitudes.length;
            // Warmth factor (0=cool, 1=hot/white), non-linear response
            const warmth = Math.min(1.0, Math.pow(avgMagnitude * 2.5, 2)); // Adjust multiplier/power

            const coolColor = { r: 0, g: 80, b: 200 };   // Cool blue
            const warmColor = { r: 255, g: 255, b: 255 }; // Hot white

            squares.forEach((square, index) => {
                // Map square index to magnitude index safely
                const magIndex = Math.min(magnitudes.length - 1, Math.floor(index * (magnitudes.length / squares.length)));
                const magnitude = magnitudes[magIndex] || 0;

                // Interpolate color based on overall warmth
                const r = coolColor.r + (warmColor.r - coolColor.r) * warmth;
                const g = coolColor.g + (warmColor.g - coolColor.g) * warmth;
                const b = coolColor.b + (warmColor.b - coolColor.b) * warmth;

                // Brightness (alpha) based on individual magnitude
                const brightness = Math.min(1.0, 0.15 + Math.pow(magnitude, 0.8) * 1.5); // Base brightness + scaled magnitude

                square.style.backgroundColor = `rgba(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)}, ${brightness})`;
            });
        }

        function connectWebSocket() {
            console.log(`Connecting to ${socketUrl}...`);
            if (socket && socket.readyState !== WebSocket.CLOSED) socket.close();
            socket = new WebSocket(socketUrl);

            socket.onopen = () => console.log('WebSocket opened');
            socket.onclose = () => setTimeout(connectWebSocket, 2000);
            socket.onerror = (error) => console.error('WebSocket error:', error);

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    let magnitudes = null;
                    if (Array.isArray(data)) magnitudes = data;
                    else if (data && Array.isArray(data.magnitudes)) magnitudes = data.magnitudes;

                    if (magnitudes) {
                        if (magnitudes.length !== numBands) {
                            numBands = magnitudes.length;
                            console.log(`Band count: ${numBands}`);
                            // Optional: Recreate grid if band count changes significantly?
                            // createGrid();
                        }
                        updateSquares(magnitudes);
                    } else {
                        // Reset squares if data is invalid?
                        // updateSquares(Array(numBands || squares.length).fill(0));
                    }
                } catch (e) {
                    console.error('WS message error:', e);
                }
            };
        }

        // --- Initialization ---
        window.addEventListener('resize', () => {
            // Simple resize handling: just recreate the grid
            createGrid();
        });

        createGrid(); // Initial grid creation
        connectWebSocket();
    </script>
</body>

</html>