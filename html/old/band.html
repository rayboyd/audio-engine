<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Band Energy Visualizer</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            /* Align bars to the bottom */
            height: 100vh;
            background-color: #222;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            gap: 10px;
            /* Space between bars */
        }

        .band-container {
            display: flex;
            align-items: flex-end;
            height: 300px;
            /* Max height of the visualizer area */
            width: 80%;
            max-width: 600px;
            border: 1px solid #444;
            background-color: #333;
            padding: 0 10px;
            /* Padding inside the container */
            gap: 10px;
        }

        .bar {
            flex-grow: 1;
            /* Make bars share space equally */
            background-color: lightblue;
            height: 0%;
            /* Start with 0 height */
            width: 15%;
            /* Relative width, adjust as needed */
            transition: height 0.05s linear;
            /* Smooth transition */
            position: relative;
            /* For label positioning */
            display: flex;
            justify-content: center;
            align-items: flex-end;
            /* Label at the bottom */
        }

        .bar::after {
            /* Label for the band */
            content: attr(data-label);
            position: absolute;
            bottom: -20px;
            /* Position label below the bar */
            color: #ccc;
            font-size: 12px;
            white-space: nowrap;
        }

        /* Optional: Different colors per band */
        #sub {
            background-color: #ff6384;
        }

        #bass {
            background-color: #ff9f40;
        }

        #lowMid {
            background-color: #ffcd56;
        }

        #mid {
            background-color: #4bc0c0;
        }

        #highMid {
            background-color: #36a2eb;
        }

        #treble {
            background-color: #9966ff;
        }
    </style>
</head>

<body>
    <div class="band-container">
        <div class="bar" id="sub" data-label="Sub"></div>
        <div class="bar" id="bass" data-label="Bass"></div>
        <div class="bar" id="lowMid" data-label="Low Mid"></div>
        <div class="bar" id="mid" data-label="Mid"></div>
        <div class="bar" id="highMid" data-label="High Mid"></div>
        <div class="bar" id="treble" data-label="Treble"></div>
    </div>

    <script>
        const wsUrl = "ws://localhost:8080"; // Make sure port matches your Go app
        let socket;

        // Get references to the bar elements
        const bars = {
            sub: document.getElementById('sub'),
            bass: document.getElementById('bass'),
            lowMid: document.getElementById('lowMid'),
            mid: document.getElementById('mid'),
            highMid: document.getElementById('highMid'),
            treble: document.getElementById('treble')
        };

        function connectWebSocket() {
            console.log(`Attempting to connect to ${wsUrl}...`);
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log("WebSocket connection established.");
            };

            socket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);

                    // Check if it's band energy data
                    if (message.type === "band_energy") {
                        // Update bar heights based on received values (0.0 to 1.0)
                        for (const bandName in bars) {
                            if (bars[bandName] && message[bandName] !== undefined) {
                                // Ensure value is between 0 and 1
                                const value = Math.max(0, Math.min(1, message[bandName]));
                                bars[bandName].style.height = `${value * 100}%`;
                            }
                        }
                    }
                    // Add handling for other message types if needed (e.g., FFT)
                    // else if (message.type === "fft_data") { ... }

                } catch (error) {
                    console.error("Error processing message:", error, "Data:", event.data);
                }
            };

            socket.onerror = (error) => {
                console.error("WebSocket error:", error);
            };

            socket.onclose = (event) => {
                console.log(`WebSocket connection closed: ${event.code} ${event.reason}. Reconnecting in 3 seconds...`);
                // Attempt to reconnect after a delay
                setTimeout(connectWebSocket, 3000);
            };
        }

        // Initial connection attempt
        connectWebSocket();
    </script>
</body>

</html>