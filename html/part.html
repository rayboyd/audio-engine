<!DOCTYPE html>
<html>

<head>
    <title>FFT Particle Visualizer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #111;
            color: #eee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            display: flex;
        }

        .canvas-container {
            flex-grow: 1;
            position: relative;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .controls-panel {
            width: 280px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #333;
            z-index: 100;
        }

        h1 {
            margin-top: 0;
            font-size: 20px;
            text-align: center;
            background: linear-gradient(45deg, #ff00cc, #3333ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .control-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .control-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #66ccff;
        }

        .slider-container {
            margin-bottom: 12px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .slider-label span:first-child {
            color: #aaa;
            font-size: 12px;
        }

        .slider-label span:last-child {
            color: #fff;
            font-size: 12px;
        }

        input[type="range"] {
            width: 100%;
            background: #333;
            height: 6px;
            border-radius: 3px;
            appearance: none;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #66ccff;
            cursor: pointer;
        }

        input[type="color"] {
            width: 100%;
            height: 30px;
            border: none;
            background: #333;
        }

        .color-presets {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .color-preset {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #333;
            transition: transform 0.1s;
        }

        .color-preset:hover {
            transform: scale(1.1);
        }

        .preset-blue {
            background: rgb(0, 128, 255);
        }

        .preset-green {
            background: rgb(0, 200, 100);
        }

        .preset-purple {
            background: rgb(150, 0, 255);
        }

        .preset-orange {
            background: rgb(255, 100, 0);
        }

        .preset-pink {
            background: rgb(255, 0, 150);
        }

        .meta-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            gap: 15px;
        }

        .meta-item {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 4px;
            font-size: 12px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-connected {
            background: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
        }

        .status-disconnected {
            background: #F44336;
        }

        .preset-button {
            padding: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            margin-top: 10px;
            width: 49%;
            transition: background 0.2s;
        }

        .preset-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .presets-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <div class="canvas-container">
        <canvas id="canvas"></canvas>
        <div class="meta-panel">
            <div class="meta-item">
                <span class="status-indicator status-disconnected" id="status-indicator"></span>
                <span id="status-text">Disconnected</span>
            </div>
            <div class="meta-item">FFT: <span id="fft-size">-</span></div>
            <div class="meta-item">FPS: <span id="fps">0</span></div>
        </div>
    </div>

    <div class="controls-panel">
        <h1>Particle FFT Visualizer</h1>

        <div class="control-group">
            <div class="control-title">Particle System</div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>Particle Count</span>
                    <span id="particle-count-value">2000</span>
                </div>
                <input type="range" id="particle-count" min="500" max="5000" step="100" value="2000">
            </div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>Base Size</span>
                    <span id="base-size-value">2</span>
                </div>
                <input type="range" id="base-size" min="0.5" max="5" step="0.1" value="2">
            </div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>Speed Factor</span>
                    <span id="speed-factor-value">1</span>
                </div>
                <input type="range" id="speed-factor" min="0.1" max="3" step="0.1" value="1">
            </div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>Decay Rate</span>
                    <span id="decay-rate-value">0.01</span>
                </div>
                <input type="range" id="decay-rate" min="0.001" max="0.05" step="0.001" value="0.01">
            </div>
        </div>

        <div class="control-group">
            <div class="control-title">Audio Response</div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>Bass Impact</span>
                    <span id="bass-impact-value">5</span>
                </div>
                <input type="range" id="bass-impact" min="0" max="10" step="0.5" value="5">
            </div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>Mid Impact</span>
                    <span id="mid-impact-value">3</span>
                </div>
                <input type="range" id="mid-impact" min="0" max="10" step="0.5" value="3">
            </div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>High Impact</span>
                    <span id="high-impact-value">2</span>
                </div>
                <input type="range" id="high-impact" min="0" max="10" step="0.5" value="2">
            </div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>Size Reactivity</span>
                    <span id="size-reactivity-value">3</span>
                </div>
                <input type="range" id="size-reactivity" min="0" max="10" step="0.5" value="3">
            </div>
        </div>

        <div class="control-group">
            <div class="control-title">Visual Effects</div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>Glow Amount</span>
                    <span id="glow-amount-value">8</span>
                </div>
                <input type="range" id="glow-amount" min="0" max="20" step="1" value="8">
            </div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>Color Intensity</span>
                    <span id="color-intensity-value">5</span>
                </div>
                <input type="range" id="color-intensity" min="1" max="10" step="1" value="5">
            </div>
            <div class="slider-container">
                <div class="slider-label">
                    <span>Base Color</span>
                </div>
                <input type="color" id="base-color" value="#0080ff">
            </div>
            <div class="color-presets">
                <div class="color-preset preset-blue" data-color="#0080ff"></div>
                <div class="color-preset preset-green" data-color="#00C864"></div>
                <div class="color-preset preset-purple" data-color="#9600FF"></div>
                <div class="color-preset preset-orange" data-color="#FF6400"></div>
                <div class="color-preset preset-pink" data-color="#FF0096"></div>
            </div>
        </div>

        <div class="control-group">
            <div class="control-title">Presets</div>
            <div class="presets-container">
                <button class="preset-button" data-preset="cosmic">Cosmic Drift</button>
                <button class="preset-button" data-preset="energy">Energy Field</button>
                <button class="preset-button" data-preset="fireflies">Fireflies</button>
                <button class="preset-button" data-preset="storm">Data Storm</button>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Status elements
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const fftSizeEl = document.getElementById('fft-size');
        const fpsEl = document.getElementById('fps');

        // Slider elements
        const sliders = {
            particleCount: document.getElementById('particle-count'),
            baseSize: document.getElementById('base-size'),
            speedFactor: document.getElementById('speed-factor'),
            decayRate: document.getElementById('decay-rate'),
            bassImpact: document.getElementById('bass-impact'),
            midImpact: document.getElementById('mid-impact'),
            highImpact: document.getElementById('high-impact'),
            sizeReactivity: document.getElementById('size-reactivity'),
            glowAmount: document.getElementById('glow-amount'),
            colorIntensity: document.getElementById('color-intensity'),
            baseColor: document.getElementById('base-color')
        };

        // Value display elements
        const valueDisplays = {
            particleCount: document.getElementById('particle-count-value'),
            baseSize: document.getElementById('base-size-value'),
            speedFactor: document.getElementById('speed-factor-value'),
            decayRate: document.getElementById('decay-rate-value'),
            bassImpact: document.getElementById('bass-impact-value'),
            midImpact: document.getElementById('mid-impact-value'),
            highImpact: document.getElementById('high-impact-value'),
            sizeReactivity: document.getElementById('size-reactivity-value'),
            glowAmount: document.getElementById('glow-amount-value'),
            colorIntensity: document.getElementById('color-intensity-value')
        };

        // Color preset elements
        const colorPresets = document.querySelectorAll('.color-preset');
        const presetButtons = document.querySelectorAll('.preset-button');

        // Visualization parameters
        let fftData = [];
        let energy = 0;
        let baseColor = [0, 128, 255]; // RGB base color
        let particles = []; // For particle visualization

        // Settings object to hold all configurable parameters
        const settings = {
            particleCount: 2000,
            baseSize: 2,
            speedFactor: 1,
            decayRate: 0.01,
            bassImpact: 5,
            midImpact: 3,
            highImpact: 2,
            sizeReactivity: 3,
            glowAmount: 8,
            colorIntensity: 5,
            baseColor: '#0080ff'
        };

        // Preset configurations
        const presets = {
            cosmic: {
                particleCount: 3000,
                baseSize: 1.5,
                speedFactor: 0.7,
                decayRate: 0.005,
                bassImpact: 3,
                midImpact: 5,
                highImpact: 2.5,
                sizeReactivity: 4,
                glowAmount: 12,
                colorIntensity: 6,
                baseColor: '#9600FF'
            },
            energy: {
                particleCount: 2000,
                baseSize: 2.5,
                speedFactor: 1.5,
                decayRate: 0.015,
                bassImpact: 7,
                midImpact: 4,
                highImpact: 3,
                sizeReactivity: 5,
                glowAmount: 10,
                colorIntensity: 8,
                baseColor: '#00C864'
            },
            fireflies: {
                particleCount: 1500,
                baseSize: 1,
                speedFactor: 0.5,
                decayRate: 0.008,
                bassImpact: 2,
                midImpact: 2,
                highImpact: 6,
                sizeReactivity: 3,
                glowAmount: 15,
                colorIntensity: 4,
                baseColor: '#FF6400'
            },
            storm: {
                particleCount: 4000,
                baseSize: 1.2,
                speedFactor: 2,
                decayRate: 0.02,
                bassImpact: 8,
                midImpact: 6,
                highImpact: 4,
                sizeReactivity: 7,
                glowAmount: 6,
                colorIntensity: 7,
                baseColor: '#0080ff'
            }
        };

        // Initialization
        let frameCount = 0;
        let lastTime = performance.now();

        // Set up high DPI canvas
        function setupCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();

            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;

            ctx.scale(dpr, dpr);
        }

        // Add event listeners to sliders
        Object.keys(sliders).forEach(key => {
            if (sliders[key]) {
                sliders[key].addEventListener('input', () => {
                    settings[key] = parseFloat(sliders[key].value);
                    if (valueDisplays[key]) {
                        valueDisplays[key].textContent = settings[key];
                    }

                    // Special case for color which needs parsing
                    if (key === 'baseColor') {
                        const hex = settings.baseColor;
                        baseColor = [
                            parseInt(hex.slice(1, 3), 16),
                            parseInt(hex.slice(3, 5), 16),
                            parseInt(hex.slice(5, 7), 16)
                        ];
                    }

                    // Regenerate particles if count changes
                    if (key === 'particleCount') {
                        initParticles(canvas.width / window.devicePixelRatio, canvas.height / window.devicePixelRatio);
                    }
                });
            }
        });

        // Add event listeners to color presets
        colorPresets.forEach(preset => {
            preset.addEventListener('click', () => {
                const color = preset.getAttribute('data-color');
                sliders.baseColor.value = color;
                settings.baseColor = color;

                const hex = settings.baseColor;
                baseColor = [
                    parseInt(hex.slice(1, 3), 16),
                    parseInt(hex.slice(3, 5), 16),
                    parseInt(hex.slice(5, 7), 16)
                ];
            });
        });

        // Add event listeners to preset buttons
        presetButtons.forEach(button => {
            button.addEventListener('click', () => {
                const presetName = button.getAttribute('data-preset');
                if (presets[presetName]) {
                    applyPreset(presets[presetName]);
                }
            });
        });

        // Apply a preset configuration
        function applyPreset(preset) {
            Object.keys(preset).forEach(key => {
                settings[key] = preset[key];
                if (sliders[key]) {
                    sliders[key].value = preset[key];
                }
                if (valueDisplays[key]) {
                    valueDisplays[key].textContent = preset[key];
                }
            });

            // Update color
            const hex = settings.baseColor;
            baseColor = [
                parseInt(hex.slice(1, 3), 16),
                parseInt(hex.slice(3, 5), 16),
                parseInt(hex.slice(5, 7), 16)
            ];

            // Regenerate particles
            initParticles(canvas.width / window.devicePixelRatio, canvas.height / window.devicePixelRatio);
        }

        // Smooth the FFT data for more pleasing visuals
        function smoothArray(array, smoothFactor) {
            if (array.length < 2) return array;

            const result = new Array(array.length);
            result[0] = array[0];

            for (let i = 1; i < array.length - 1; i++) {
                result[i] = array[i - 1] * smoothFactor +
                    array[i] * (1 - 2 * smoothFactor) +
                    array[i + 1] * smoothFactor;
            }

            result[array.length - 1] = array[array.length - 1];
            return result;
        }

        // Draw the visualization
        function draw() {
            // Set up frame timing
            const now = performance.now();
            frameCount++;

            if (now - lastTime > 1000) {
                fpsEl.textContent = Math.round(frameCount * 1000 / (now - lastTime));
                frameCount = 0;
                lastTime = now;
            }

            // Clear canvas
            const width = canvas.width / window.devicePixelRatio;
            const height = canvas.height / window.devicePixelRatio;
            ctx.clearRect(0, 0, width, height);

            // Render particles if we have FFT data
            if (fftData.length) {
                renderParticles(ctx, width, height);
            }

            // Request next frame
            requestAnimationFrame(draw);
        }

        // Initialize particle system
        function initParticles(width, height) {
            particles = [];

            for (let i = 0; i < settings.particleCount; i++) {
                particles.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    size: settings.baseSize * (0.5 + Math.random() * 1.5),
                    speedX: (Math.random() - 0.5) * 2 * settings.speedFactor,
                    speedY: (Math.random() - 0.5) * 2 * settings.speedFactor,
                    life: Math.random()
                });
            }
        }

        // Render particles
        function renderParticles(ctx, width, height) {
            // Use the energy to make color more intense
            const colorIntensity = Math.min(1, energy * settings.colorIntensity);
            const r = Math.round(baseColor[0] + (255 - baseColor[0]) * colorIntensity);
            const g = Math.round(baseColor[1] * (1 - colorIntensity * 0.5));
            const b = Math.round(baseColor[2] * (1 - colorIntensity * 0.7));

            // Update particles based on FFT data
            updateParticles(width, height);

            // Draw particles
            ctx.shadowBlur = settings.glowAmount * energy;
            ctx.shadowColor = `rgba(${r}, ${g}, ${b}, 0.7)`;

            for (let p of particles) {
                const alpha = Math.min(1, p.life);
                ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${alpha})`;

                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.shadowBlur = 0;
        }

        // Update particle positions and properties
        function updateParticles(width, height) {
            if (!fftData.length) return;

            const smoothedData = smoothArray(fftData, 0.3);
            const bassEnergy = getBandEnergy(smoothedData, 0, 10) * settings.bassImpact;
            const midEnergy = getBandEnergy(smoothedData, 10, 30) * settings.midImpact;
            const highEnergy = getBandEnergy(smoothedData, 30, smoothedData.length) * settings.highImpact;

            for (let p of particles) {
                // Update position
                p.x += p.speedX * (1 + bassEnergy * 0.2);
                p.y += p.speedY * (1 + midEnergy * 0.2);

                // Bounce off walls
                if (p.x < 0 || p.x > width) {
                    p.speedX *= -1;
                }
                if (p.y < 0 || p.y > height) {
                    p.speedY *= -1;
                }

                // Update life based on decay rate
                p.life -= settings.decayRate;
                if (p.life <= 0) {
                    p.life = 1;
                    p.x = Math.random() * width;
                    p.y = Math.random() * height;
                    p.size = settings.baseSize * (0.5 + Math.random() * 1.5) + highEnergy * 0.4;
                }

                // Adjust size based on energy and reactivity
                p.size = Math.max(
                    settings.baseSize * 0.5,
                    p.size + (energy * settings.sizeReactivity * 0.02) - (settings.decayRate * 5)
                );
            }
        }

        // Calculate energy in a specific frequency band
        function getBandEnergy(data, start, end) {
            let sum = 0;
            for (let i = start; i < Math.min(end, data.length); i++) {
                sum += data[i];
            }
            return sum / (end - start);
        }

        // Handle WebSocket connection
        function connectWebSocket() {
            let ws = new WebSocket('ws://localhost:8080/ws');

            ws.onopen = function () {
                console.log('Connected to WebSocket');
                statusIndicator.className = 'status-indicator status-connected';
                statusText.textContent = 'Connected';
            };

            ws.onclose = function () {
                console.log('Disconnected from WebSocket');
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = 'Disconnected';

                // Try to reconnect after a delay
                setTimeout(connectWebSocket, 2000);
            };

            ws.onerror = function (error) {
                console.error('WebSocket error:', error);
            };

            ws.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);

                    // Handle different data types
                    if (Array.isArray(data)) {
                        fftData = data;
                    } else if (data.fftSize !== undefined) {
                        // Update metadata
                        fftSizeEl.textContent = data.fftSize;

                        if (data.energy !== undefined) {
                            energy = data.energy;
                        }
                    }
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            };
        }

        // Parse initial base color
        const hex = settings.baseColor;
        baseColor = [
            parseInt(hex.slice(1, 3), 16),
            parseInt(hex.slice(3, 5), 16),
            parseInt(hex.slice(5, 7), 16)
        ];

        // Initialize the visualization
        window.addEventListener('resize', () => {
            setupCanvas();
            initParticles(canvas.width / window.devicePixelRatio, canvas.height / window.devicePixelRatio);
        });
        setupCanvas();
        initParticles(canvas.width / window.devicePixelRatio, canvas.height / window.devicePixelRatio);
        connectWebSocket();
        draw();
    </script>
</body>

</html>